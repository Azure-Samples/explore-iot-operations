# Copyright (c) Microsoft Corporation.
# Licensed under the MIT License.
apiVersion: v1
kind: ServiceAccount
metadata:
  name: mqtt-publisher
  namespace: azure-iot-operations
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mqtt-publisher
  namespace: azure-iot-operations
spec:
  replicas: 1
  selector:
    matchLabels:
      app: mqtt-publisher
  template:
    metadata:
      labels:
        app: mqtt-publisher
    spec:
      serviceAccountName: mqtt-publisher
      containers:
      - name: mqtt-publisher
        image: alpine
        command: ["sh", "-c"]
        args:
        - |
          apk --no-cache add mosquitto-clients

          SLEEP_DURATION=2
          REPORT_INTERVAL=10
          MSG_COUNT=0
          SECONDS=0
          
          echo "Starting simulator"
          while true; do
            DATA="{
                \"timestamp\": \"$(date -u +'%Y-%m-%dT%H:%M:%SZ')\",
                \"sensor_id\": \"Sensor-$(hostname)-$$\",
                \"msg_number\": $MSG_COUNT,
                \"temperature\": $(awk -v min=550 -v max=600 'BEGIN{srand(); print min+rand()*(max-min)}'),
                \"pressure\": $(awk -v min=290 -v max=300 'BEGIN{srand(); print min+rand()*(max-min)}'),
                \"vibration\": $(awk -v min=0.001 -v max=0.005 'BEGIN{srand(); print min+rand()*(max-min)}')
              }"

            mosquitto_pub -i mqtt-publisher -q 1 -L mqtt://aio-mq-dmqtt-frontend/sensor/data -m "$DATA"
            if [ $? -eq 0 ]; then
              MSG_COUNT=$((MSG_COUNT+1))
            else
              echo "Publish failed for message number $MSG_COUNT, will retry"
            fi

            SECONDS=$((SECONDS+$SLEEP_DURATION))
            
            if [ $SECONDS -ge $REPORT_INTERVAL ]; then
              echo "Published $MSG_COUNT messages"
              SECONDS=0
            fi

            sleep $SLEEP_DURATION
          done
 