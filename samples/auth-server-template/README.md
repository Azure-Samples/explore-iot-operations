# auth-server-template

This is a sample server for Azure IoT MQ broker custom authentication. 

The custom authentication feature of the IoT MQ MQTT brokers provides an extension point that allows customers to plug in an authentication server to authenticate clients that connect to the MQTT broker. The server here is intended as a sample for how such a custom authentication can be implemented.

## Deploying the template

A private preview image of the template is available with the tag `e4kpreview.azurecr.io/auth-server-template:latest`. You only need to deploy the template yourself once you make modifications.

The template server needs to be built and deployed as a Kubernetes service. You will need to provide the repository for hosting its container image.

To deploy, run the [build_image.sh](deploy/build_image.sh) script and pass the image tag to use. This script builds and pushes the template image.

```sh
IMAGE_TAG=example.example.io/auth-server-template:latest ./deploy/build_image.sh
```

## Running the template

1. Run the [make_credentials.sh](deploy/make_credentials.sh) script to generate server credentials for the template. This script generates test certificates and saves them as Kubernetes secrets.

```sh
./deploy/make_credentials.sh
```

2. If you are using your own container register, edit [auth-server-template.yaml](deploy/auth-server-template.yaml#L10) and set the image that you created in the previous section.

3. Deploy the pod and service for the template.

```sh
kubectl apply -f ./deploy/auth-server-template.yaml
```

5. When finished, run [cleanup.sh](deploy/cleanup.sh) to delete resources.

## Using the template

Add the custom authentication method to your IoT MQ BrokerAuthentication resource. An example of the fields to add is below:

```yaml
authenticationMethods:
  - custom:;
      # Required, must match the pod name in auth-server-template.yaml
      endpoint: https://auth-server-template
      # Required, as this template uses a self-signed CA.
      ca_cert: custom-auth-ca
      # Optional; this example uses the client cert generated by make_credentials.sh
      auth:
        x509:
          secretName: custom-auth-client-cert
```

The auth server template will approve authentication requests from all clients, except clients providing usernames that start with `deny`.
